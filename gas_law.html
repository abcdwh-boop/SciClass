<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶„ì ë³´ë“œê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            touch-action: manipulation; /* ëª¨ë°”ì¼ì—ì„œ ë”ë¸” íƒ­ í™•ëŒ€ ë°©ì§€ */
        }
        .piece {
            transition: all 0.5s ease-in-out;
            cursor: pointer;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
        }
        .gauge-slot, .graveyard-slot {
            transition: background-color 0.3s;
        }
        #card-modal {
            transition: opacity 0.3s, transform 0.3s;
        }
        .card-button {
            transition: transform 0.2s, background-color 0.2s;
        }
        .card-button:hover:not(:disabled) {
            transform: translateY(-4px);
        }
        .card-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        #game-over-modal {
            animation: fadeIn 0.5s ease-in-out;
        }
        .winner-card {
            animation: slideInUp 0.5s ease-in-out forwards;
            opacity: 0;
        }
        .winner-card:nth-child(1) { animation-delay: 0.2s; }
        .winner-card:nth-child(2) { animation-delay: 0.4s; }
        .winner-card:nth-child(3) { animation-delay: 0.6s; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes explode {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: scale(0) rotate(360deg);
                opacity: 0;
                filter: blur(5px);
            }
        }

        .exploding {
            animation: explode 0.5s ease-in-out forwards;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
        body {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        body::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-4 text-gray-800">ë¶„ì ì„œë°”ì´ë²Œ ë³´ë“œê²Œì„</h1>
        <div class="flex flex-col md:flex-row gap-8">
            <!-- ë¶€í”¼ ê²Œì´ì§€ -->
            <div id="volume-gauge" class="flex-shrink-0 w-full md:w-64 bg-white rounded-xl shadow-lg p-2 flex flex-row md:flex-col justify-around md:justify-start gap-1">
            </div>

            <!-- ê²Œì„ ê³µê°„ (ì£½ì€ ë§ & ì •ë³´) -->
            <div class="flex-grow grid grid-rows-9 gap-4">
                <!-- 256L ~ 16L -->
                <div id="graveyard" class="bg-white rounded-xl shadow-lg p-4 row-span-5 flex flex-col">
                    <h2 class="text-xl font-bold text-center text-gray-700 mb-4 flex-shrink-0">ì£½ì€ ë§</h2>
                    <div id="graveyard-slots" class="grid grid-cols-3 sm:grid-cols-6 md:grid-cols-3 gap-2 justify-items-center content-start flex-grow">
                    </div>
                </div>
                <!-- 8L ~ 1L -->
                <!-- ë¶„ì ì •ë³´ ì»¨í…Œì´ë„ˆ -->
                <div id="molecule-info-container" class="bg-white rounded-xl shadow-lg p-4 row-span-4 flex flex-col overflow-y-auto">
                    <!-- JSë¡œ ë‚´ìš©ì´ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ê²Œì„ ì¹´ë“œ ëª¨ë‹¬ (ì´ˆê¸° ë²„ì „: 2ì—´ ê·¸ë¦¬ë“œ, ì••ë ¥ í…ìŠ¤íŠ¸ ì œê±°, 2 ì¹´ë“œ ì œê±°) -->
    <div id="card-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div id="card-container" class="bg-white rounded-lg shadow-2xl p-6 w-11/12 max-w-md relative">
            <h3 class="text-xl font-bold mb-4 text-center">ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
            <div class="grid grid-cols-2 gap-3">
                <button data-card="1/2" class="card-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">1/2</button>
                <button data-card="1/4" class="card-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">1/4</button>
                <button data-card="1/8" class="card-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">1/8</button>
                <button data-card="4" class="card-button bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg">4</button>
                <button data-card="bomb" id="bomb-card" class="card-button bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg">í­íƒ„</button>
                <button data-card="absolute" class="card-button bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg">ì ˆëŒ€ ì¹´ë“œ</button>
            </div>
            <button id="close-modal-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
        </div>
    </div>

    <!-- ê²Œì„ ì¢…ë£Œ ëª¨ë‹¬ -->
    <div id="game-over-modal" class="hidden fixed inset-0 bg-gradient-to-br from-blue-400 to-purple-500 flex flex-col items-center justify-center p-4">
        <div class="text-center text-white">
            <h2 class="text-5xl font-extrabold mb-4" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">ê²Œì„ ì¢…ë£Œ!</h2>
            <p class="text-2xl mb-8">ìµœì¢… ìƒì¡´ìë“¤ì…ë‹ˆë‹¤!</p>
            <div id="winners-list" class="flex flex-col md:flex-row gap-6 justify-center items-center mb-10">
                <!-- Winners will be injected here -->
            </div>
            <button id="restart-btn" class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold py-4 px-8 rounded-full text-2xl shadow-lg transform hover:scale-105 transition-transform">
                ë‹¤ìŒ íŒ!
            </button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const PIECES = [
                // ë‹¨ì›ì
                { id: 'He', type: 'monatomic', color: 'bg-red-400' },
                { id: 'Ne', type: 'monatomic', color: 'bg-orange-400' },
                { id: 'Ar', type: 'monatomic', color: 'bg-amber-400' },
                // ì´ì›ì
                { id: 'H2', type: 'diatomic', color: 'bg-lime-400' },
                { id: 'O2', type: 'diatomic', color: 'bg-green-400' },
                { id: 'N2', type: 'diatomic', color: 'bg-emerald-400' },
                // ì‚¼ì›ì
                { id: 'H2O', type: 'triatomic', color: 'bg-cyan-400' },
                { id: 'CO2', type: 'triatomic', color: 'bg-sky-400' },
                { id: 'O3', type: 'triatomic', color: 'bg-indigo-400' },
            ];
            const VOLUMES = [256, 128, 64, 32, 16, 8, 4, 2, 1];
            const MOLECULE_DATA = {
                'He': {
                    name: 'í—¬ë¥¨ (Helium)',
                    modelUrl: 'https://placehold.co/200x150/f87171/ffffff?text=He&font=sans',
                    features: 'ë¬´ìƒ‰, ë¬´ì·¨ì˜ ë¹„í™œì„± ê¸°ì²´ë¡œ, ìš°ì£¼ì—ì„œ ìˆ˜ì†Œ ë‹¤ìŒìœ¼ë¡œ í’ë¶€í•œ ì›ì†Œì…ë‹ˆë‹¤. ë§¤ìš° ê°€ë³ê³  ì•ˆì „í•˜ì—¬ ê³µê¸°ë³´ë‹¤ ì‰½ê²Œ ë– ì˜¤ë¦…ë‹ˆë‹¤.',
                    usage: 'íŒŒí‹°ìš© í’ì„ ì´ë‚˜ ë¹„í–‰ì„ ì„ ë„ìš°ëŠ” ë° ì‚¬ìš©ë˜ë©°, MRI ì¥ë¹„ì˜ ì´ˆì „ë„ ìì„ ëƒ‰ê°, ìš©ì ‘ ì‹œ ë¶ˆí™œì„± ë³´í˜¸ë§‰ìœ¼ë¡œë„ ì¤‘ìš”í•˜ê²Œ ì“°ì…ë‹ˆë‹¤.'
                },
                'Ne': {
                    name: 'ë„¤ì˜¨ (Neon)',
                    modelUrl: 'https://placehold.co/200x150/fb923c/ffffff?text=Ne&font=sans',
                    features: 'ë¹„í™œì„± ê¸°ì²´ ì¤‘ í•˜ë‚˜ë¡œ, ì „ê¸°ë¥¼ í†µê³¼ì‹œí‚¤ë©´ ë°ì€ ì£¼í™©ìƒ‰ ë¹›ì„ ë‚´ëŠ” íŠ¹ì§•ì´ ìˆìŠµë‹ˆë‹¤. ê³µê¸° ì¤‘ì— ë§¤ìš° ì ì€ ì–‘ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
                    usage: 'í™”ë ¤í•œ ë„ì‹œì˜ ë°¤ì„ ë§Œë“œëŠ” ë„¤ì˜¨ì‚¬ì¸ ê´‘ê³ íŒì— ì£¼ë¡œ ì‚¬ìš©ë˜ë©°, TV ë¸Œë¼ìš´ê´€ì´ë‚˜ ë ˆì´ì € ë“± íŠ¹ìˆ˜ ì¥ë¹„ì—ë„ í™œìš©ë©ë‹ˆë‹¤.'
                },
                'Ar': {
                    name: 'ì•„ë¥´ê³¤ (Argon)',
                    modelUrl: 'https://placehold.co/200x150/fbbf24/ffffff?text=Ar&font=sans',
                    features: 'ì§€êµ¬ ëŒ€ê¸° ì¤‘ì— ì§ˆì†Œ, ì‚°ì†Œ ë‹¤ìŒìœ¼ë¡œ ë§ì€ ë¹„í™œì„± ê¸°ì²´ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì›ì†Œì™€ ê±°ì˜ ë°˜ì‘í•˜ì§€ ì•ŠëŠ” ì•ˆì •ì ì¸ ì„±ì§ˆì„ ê°€ì§‘ë‹ˆë‹¤.',
                    usage: 'ë°±ì—´ì „êµ¬ ë‚´ë¶€ë¥¼ ì±„ì›Œ í•„ë¼ë©˜íŠ¸ê°€ íƒ€ëŠ” ê²ƒì„ ë§‰ê±°ë‚˜, ê³ í’ˆì§ˆ ìš©ì ‘ ì‹œ ì‚°í™”ë¥¼ ë°©ì§€í•˜ëŠ” ë³´í˜¸ ê°€ìŠ¤ë¡œ ë„ë¦¬ ì‚¬ìš©ë©ë‹ˆë‹¤.'
                },
                'H2': {
                    name: 'ìˆ˜ì†Œ (Hydrogen)',
                    modelUrl: 'https://placehold.co/200x150/a3e635/ffffff?text=Hâ‚‚&font=sans',
                    features: 'ê°€ì¥ ê°€ë²¼ìš´ ì›ì†Œì´ë©° ìš°ì£¼ì—ì„œ ê°€ì¥ í’ë¶€í•œ ë¬¼ì§ˆì…ë‹ˆë‹¤. ê°€ì—°ì„±ì´ ë§¤ìš° ë†’ì•„ ë¶ˆê³¼ ë§Œë‚˜ë©´ í­ë°œí•  ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.',
                    usage: 'ë¬¼ì„ ë§Œë“œëŠ” êµ¬ì„± ìš”ì†Œì´ë©°, ë¯¸ë˜ì˜ ì¹œí™˜ê²½ ì—ë„ˆì§€ì›ìœ¼ë¡œ ì£¼ëª©ë°›ëŠ” ìˆ˜ì†Œ ìë™ì°¨ì˜ ì—°ë£Œ, ìš°ì£¼ ì™•ë³µì„ ì˜ ë¡œì¼“ ì—°ë£Œë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.'
                },
                'O2': {
                    name: 'ì‚°ì†Œ (Oxygen)',
                    modelUrl: 'https://placehold.co/200x150/4ade80/ffffff?text=Oâ‚‚&font=sans',
                    features: 'ìƒëª…ì²´ê°€ í˜¸í¡í•˜ëŠ” ë° í•„ìˆ˜ì ì¸ ê¸°ì²´ë¡œ, ì§€êµ¬ ëŒ€ê¸°ì˜ ì•½ 21%ë¥¼ ì°¨ì§€í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ë¬¼ì§ˆì´ íƒ€ëŠ” ê²ƒì„ ë•ëŠ” ì¡°ì—°ì†Œì„± ê¸°ì²´ì…ë‹ˆë‹¤.',
                    usage: 'ë³‘ì›ì—ì„œ í™˜ìì˜ í˜¸í¡ì„ ë•ê±°ë‚˜, ì² ì„ ìƒì‚°í•˜ëŠ” ì œì²  ê³µì •, ê¸ˆì†ì„ ì ˆë‹¨í•˜ê³  ìš©ì ‘í•˜ëŠ” ë° í•„ìˆ˜ì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.'
                },
                'N2': {
                    name: 'ì§ˆì†Œ (Nitrogen)',
                    modelUrl: 'https://placehold.co/200x150/34d399/ffffff?text=Nâ‚‚&font=sans',
                    features: 'ì§€êµ¬ ëŒ€ê¸°ì˜ ì•½ 78%ë¥¼ ì°¨ì§€í•˜ëŠ” ê°€ì¥ í”í•œ ê¸°ì²´ì…ë‹ˆë‹¤. ë§¤ìš° ì•ˆì •ì ì´ì–´ì„œ ë‹¤ë¥¸ ë¬¼ì§ˆê³¼ ì˜ ë°˜ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
                    usage: 'ê³¼ì ë´‰ì§€ ì•ˆì— ë‚´ìš©ë¬¼ì´ ë¶€ì„œì§€ì§€ ì•Šê³  ì‹ ì„ í•˜ê²Œ ìœ ì§€ë˜ë„ë¡ ì±„ìš°ëŠ” ìš©ë„ë‚˜, ì‹ë¬¼ ì„±ì¥ì— í•„ìˆ˜ì ì¸ ë¹„ë£Œì˜ ì›ë£Œë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.'
                },
                'H2O': {
                    name: 'ë¬¼ (Water)',
                    modelUrl: 'https://placehold.co/200x150/22d3ee/ffffff?text=Hâ‚‚O&font=sans',
                    features: 'ì§€êµ¬ í‘œë©´ì˜ ì•½ 71%ë¥¼ ë®ê³  ìˆìœ¼ë©°, ìƒëª… ìœ ì§€ì— í•„ìˆ˜ì ì¸ ì•¡ì²´ì…ë‹ˆë‹¤. ê³ ì²´(ì–¼ìŒ), ì•¡ì²´(ë¬¼), ê¸°ì²´(ìˆ˜ì¦ê¸°) ì„¸ ê°€ì§€ ìƒíƒœë¡œ ì¡´ì¬í•©ë‹ˆë‹¤.',
                    usage: 'ìš°ë¦¬ê°€ ë§ˆì‹œê³ , ì”»ê³ , ìš”ë¦¬í•˜ëŠ” ëª¨ë“  í™œë™ì— ì‚¬ìš©ë˜ë©°, ë†ì—…ìš©ìˆ˜ë‚˜ ìˆ˜ë ¥ ë°œì „ì„ í†µí•œ ì „ê¸° ìƒì‚° ë“±ì—ë„ í™œìš©ë©ë‹ˆë‹¤.'
                },
                'CO2': {
                    name: 'ì´ì‚°í™”íƒ„ì†Œ (Carbon Dioxide)',
                    modelUrl: 'https://placehold.co/200x150/38bdf8/ffffff?text=COâ‚‚&font=sans',
                    features: 'ì‚¬ëŒì˜ ë‚ ìˆ¨ì— í¬í•¨ëœ ê¸°ì²´ì´ë©°, ì‹ë¬¼ì´ ê´‘í•©ì„±ì„ í†µí•´ ì–‘ë¶„ì„ ë§Œë“œëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì§€êµ¬ ì˜¨ë‚œí™”ì˜ ì£¼ëœ ì›ì¸ì´ ë˜ëŠ” ì˜¨ì‹¤ê°€ìŠ¤ì´ê¸°ë„ í•©ë‹ˆë‹¤.',
                    usage: 'í†¡ ì˜ëŠ” ë§›ì„ ë‚´ëŠ” íƒ„ì‚°ìŒë£Œë¥¼ ë§Œë“¤ê±°ë‚˜, ë¶ˆì„ ë„ëŠ” ì†Œí™”ê¸°, ê³µì—°ì—ì„œ ì•ˆê°œ íš¨ê³¼ë¥¼ ë‚´ëŠ” ë“œë¼ì´ì•„ì´ìŠ¤ì˜ ì›ë£Œë¡œ ì“°ì…ë‹ˆë‹¤.'
                },
                'O3': {
                    name: 'ì˜¤ì¡´ (Ozone)',
                    modelUrl: 'https://placehold.co/200x150/818cf8/ffffff?text=Oâ‚ƒ&font=sans',
                    features: 'íŠ¹ìœ ì˜ ëƒ„ìƒˆë¥¼ ê°€ì§„ í‘¸ë¥¸ë¹› ê¸°ì²´ë¡œ, ê°•ë ¥í•œ ì‚°í™”ë ¥ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì„±ì¸µê¶Œì˜ ì˜¤ì¡´ì¸µì€ ì§€êµ¬ë¥¼ ìì™¸ì„ ìœ¼ë¡œë¶€í„° ë³´í˜¸í•˜ëŠ” ì¤‘ìš”í•œ ì—­í• ì„ í•©ë‹ˆë‹¤.',
                    usage: 'ê°•ë ¥í•œ ì‚´ê·  ë° ì†Œë… ëŠ¥ë ¥ì„ ì´ìš©í•´ ë¬¼ì„ ì •í™”í•˜ê±°ë‚˜, ìˆ˜ì˜ì¥ ì†Œë…, ê³µê¸° ì²­ì • ë“±ì— ì œí•œì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.'
                }
            };

            let gaugeState = []; // ë³´ë“œ ìœ„ ë§ë“¤ì˜ ìƒíƒœ (ID ë°°ì—´)
            let graveyardState = []; // ì£½ì€ ë§ë“¤ì˜ ìƒíƒœ (ID ë°°ì—´)
            let selectedPiece = { id: null, index: -1 };

            const volumeGauge = document.getElementById('volume-gauge');
            const graveyardSlots = document.getElementById('graveyard-slots');
            const cardModal = document.getElementById('card-modal');
            const cardContainer = document.getElementById('card-container');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const gameOverModal = document.getElementById('game-over-modal');
            const restartBtn = document.getElementById('restart-btn');

            function formatId(id) {
                // ìˆ«ìë¥¼ ì°¾ì•„ <sub> íƒœê·¸ë¡œ ê°ì‹¸ì„œ ì•„ë˜ì²¨ìë¡œ ë§Œë“­ë‹ˆë‹¤
                return id.replace(/(\d+)/g, '<sub>$1</sub>');
            }

            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function initGame() {
                // íƒ€ì…ë³„ë¡œ ë§ ì„ê¸°
                const monatomic = shuffle(PIECES.filter(p => p.type === 'monatomic').map(p => p.id));
                const diatomic = shuffle(PIECES.filter(p => p.type === 'diatomic').map(p => p.id));
                const triatomic = shuffle(PIECES.filter(p => p.type === 'triatomic').map(p => p.id));
                
                // ìˆœì„œëŒ€ë¡œ ë°°ì¹˜
                gaugeState = [...triatomic, ...diatomic, ...monatomic];
                graveyardState = [];
                
                gameOverModal.classList.add('hidden');
                renderBoard();
                updateMoleculeInfo();
            }
            
            function createPieceElement(pieceId) {
                const pieceInfo = PIECES.find(p => p.id === pieceId);
                const pieceEl = document.createElement('div');
                pieceEl.className = `piece w-14 h-14 md:w-20 md:h-12 rounded-lg flex items-center justify-center text-white font-bold text-lg md:text-xl shadow-md ${pieceInfo.color}`;
                pieceEl.innerHTML = formatId(pieceInfo.id);
                pieceEl.dataset.id = pieceId;

                pieceEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = gaugeState.indexOf(pieceId);
                    if (index > -1) {
                        selectedPiece = { id: pieceId, index: index };
                        openCardModal();
                    }
                });
                return pieceEl;
            }

            function renderBoard() {
                // ë¶€í”¼ ê²Œì´ì§€ ë Œë”ë§
                volumeGauge.innerHTML = '';
                VOLUMES.forEach((volume, index) => {
                    const gaugeSlot = document.createElement('div');
                    gaugeSlot.className = 'gauge-slot border-2 border-gray-200 rounded-lg flex items-center p-1 gap-2 h-16 md:h-auto';
                    
                    const volumeLabel = document.createElement('span');
                    volumeLabel.className = 'text-sm font-semibold text-gray-500 w-12 text-right';
                    volumeLabel.textContent = `${volume}L`;
                    
                    const pieceContainer = document.createElement('div');
                    pieceContainer.className = 'flex-grow h-full flex items-center justify-center';

                    if (gaugeState[index]) {
                        const pieceEl = createPieceElement(gaugeState[index]);
                         pieceContainer.appendChild(pieceEl);
                    }
                    
                    gaugeSlot.appendChild(volumeLabel);
                    gaugeSlot.appendChild(pieceContainer);
                    volumeGauge.appendChild(gaugeSlot);
                });

                // ì£½ì€ ë§ ë Œë”ë§
                graveyardSlots.innerHTML = '';
                for(let i=0; i<6; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'graveyard-slot w-20 h-16 bg-gray-200 rounded-lg flex items-center justify-center';
                    if (graveyardState[i]) {
                        const pieceInfo = PIECES.find(p => p.id === graveyardState[i]);
                        slot.classList.remove('bg-gray-200');
                        slot.classList.add(pieceInfo.color, 'opacity-50');
                        slot.innerHTML = formatId(pieceInfo.id);
                        slot.classList.add('text-white', 'font-bold');
                    }
                    graveyardSlots.appendChild(slot);
                }
                
                checkGameOver();
            }

            function openCardModal() {
                // í­íƒ„ ì¹´ë“œ í™œì„±í™”/ë¹„í™œì„±í™”
                const bombCard = document.getElementById('bomb-card');
                const isLastPiece = selectedPiece.index === gaugeState.length - 1;
                bombCard.disabled = !isLastPiece;

                cardModal.classList.remove('hidden');
                cardModal.classList.add('flex');
            }

            function closeCardModal() {
                cardModal.classList.add('hidden');
                cardModal.classList.remove('flex');
                selectedPiece = { id: null, index: -1 };
            }
            
            function handleCardClick(effect) {
                const { id, index } = selectedPiece;
                if (!id) return;

                closeCardModal();

                if (effect === 'bomb' && index === gaugeState.length - 1) {
                    animateBombEffect(index);
                } else {
                    const stateUpdateFunction = () => {
                        let newIndex;
                        switch (effect) {
                            case '1/2':
                                newIndex = Math.max(0, index - 1);
                                if (newIndex !== index) movePiece(index, newIndex);
                                break;
                            case '1/4':
                                newIndex = Math.max(0, index - 2);
                                if (newIndex !== index) movePiece(index, newIndex);
                                break;
                            case '1/8':
                                newIndex = Math.max(0, index - 3);
                                if (newIndex !== index) movePiece(index, newIndex);
                                break;
                            case '4':
                                newIndex = Math.min(gaugeState.length - 1, index + 2);
                                if (newIndex !== index) movePiece(index, newIndex);
                                break;
                            case 'absolute':
                                newIndex = gaugeState.length - 1;
                                if (newIndex !== index) movePiece(index, newIndex);
                                break;
                        }
                    };
                    animateThenRender(stateUpdateFunction);
                }
            }

            function animateThenRender(updateLogic) {
                const oldPositions = new Map();
                // ì• ë‹ˆë©”ì´ì…˜ ì „, ê° ë§ì˜ ì´ì „ ìœ„ì¹˜ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.
                document.querySelectorAll('.piece').forEach(p => {
                    oldPositions.set(p.dataset.id, p.getBoundingClientRect());
                });

                // ê²Œì„ì˜ ìƒíƒœ(ë°°ì—´)ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                updateLogic();

                // ì—…ë°ì´íŠ¸ëœ ìƒíƒœë¡œ ë³´ë“œë¥¼ ë‹¤ì‹œ ë Œë”ë§í•©ë‹ˆë‹¤. (ì´ë•Œ ë§ë“¤ì€ DOMìƒì—ì„œ ìµœì¢… ìœ„ì¹˜ë¡œ ìˆœê°„ì´ë™í•©ë‹ˆë‹¤)
                renderBoard();

                const piecesToAnimate = [];
                document.querySelectorAll('.piece').forEach(p => {
                    piecesToAnimate.push(p);
                });

                // FLIP ì• ë‹ˆë©”ì´ì…˜ ê¸°ë²• (First, Last, Invert, Play)
                piecesToAnimate.forEach(piece => {
                    const oldPos = oldPositions.get(piece.dataset.id);
                    if (!oldPos) return;
                    
                    const newPos = piece.getBoundingClientRect();

                    const deltaX = oldPos.left - newPos.left;
                    const deltaY = oldPos.top - newPos.top;
                    
                    // ì›€ì§ì„ì´ ê±°ì˜ ì—†ëŠ” ë§ì€ ì• ë‹ˆë©”ì´ì…˜ì„ ì ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    if (Math.abs(deltaX) < 0.5 && Math.abs(deltaY) < 0.5) return;

                    // INVERT: ë§ì´ ì´ì „ ìœ„ì¹˜ì— ìˆëŠ” ê²ƒì²˜ëŸ¼ ë³´ì´ê²Œ ì¦‰ì‹œ transformì„ ì ìš©í•©ë‹ˆë‹¤. (ì• ë‹ˆë©”ì´ì…˜ ì—†ì´)
                    piece.style.transition = 'none';
                    piece.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                });
                
                // ë¸Œë¼ìš°ì €ê°€ ìœ„ì˜ ìŠ¤íƒ€ì¼ ë³€ê²½ì„ ë Œë”ë§í•  ì‹œê°„ì„ ì¤ë‹ˆë‹¤.
                // requestAnimationFrameì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ìŒ í”„ë ˆì„ì—ì„œ ì• ë‹ˆë©”ì´ì…˜ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
                requestAnimationFrame(() => {
                     // PLAY: ì´ì œ transitionì„ í™œì„±í™”í•˜ê³  transformì„ ì›ë˜ëŒ€ë¡œ ë˜ëŒë ¤ ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
                    piecesToAnimate.forEach(piece => {
                        piece.style.transition = 'transform 0.5s ease-in-out';
                        piece.style.transform = ''; // 'translate(0, 0)'ê³¼ ê°™ìŠµë‹ˆë‹¤.
                    });
                });
                
                // ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚œ í›„, ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì„ ì •ë¦¬í•˜ì—¬ ë‹¤ìŒ ì• ë‹ˆë©”ì´ì…˜ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.
                setTimeout(() => {
                    piecesToAnimate.forEach(piece => {
                        piece.style.transition = '';
                    });
                }, 500);
            }
            
            function animateBombEffect(index) {
                const pieceId = gaugeState[index];
                const pieceElement = document.querySelector(`.piece[data-id="${pieceId}"]`);

                if (pieceElement) {
                    pieceElement.classList.add('exploding');
                    
                    // ì• ë‹ˆë©”ì´ì…˜ ì§€ì† ì‹œê°„(0.5ì´ˆ) í›„ì— ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ì¬ë Œë”ë§
                    setTimeout(() => {
                        killPiece(index);
                        renderBoard();
                    }, 500); 
                } else {
                    // ë§Œì•½ ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì§€ ëª»í•˜ë©´, ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ë°”ë¡œ ì‹¤í–‰
                    killPiece(index);
                    renderBoard();
                }
            }

            function movePiece(oldIndex, newIndex) {
                const pieceId = gaugeState.splice(oldIndex, 1)[0];
                gaugeState.splice(newIndex, 0, pieceId);
            }

            function killPiece(index) {
                const killedPieceId = gaugeState.splice(index, 1)[0];
                if(killedPieceId) {
                    graveyardState.push(killedPieceId);
                    updateMoleculeInfo();
                }
            }
            
            function updateMoleculeInfo() {
                const infoContainer = document.getElementById('molecule-info-container');
                const lastKilled = graveyardState.length > 0 ? graveyardState[graveyardState.length - 1] : null;

                if (lastKilled && MOLECULE_DATA[lastKilled]) {
                    const data = MOLECULE_DATA[lastKilled];
                    infoContainer.innerHTML = `
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex-shrink-0">${data.name}</h3>
                        <div class="flex flex-col sm:flex-row gap-4 items-center flex-grow">
                            <img src="${data.modelUrl}" alt="${data.name} ë¶„ì ëª¨í˜•" class="w-full sm:w-48 rounded-lg object-cover shadow-md">
                            <div class="flex-grow">
                                <h4 class="font-bold text-gray-700 mt-2 sm:mt-0">íŠ¹ì§•</h4>
                                <p class="text-gray-600 mb-2 text-sm">${data.features}</p>
                                <h4 class="font-bold text-gray-700">ì‹¤ìƒí™œ í™œìš©</h4>
                                <p class="text-gray-600 text-sm">${data.usage}</p>
                            </div>
                        </div>
                    `;
                } else {
                    infoContainer.innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <p class="font-semibold">ì•„ì§ ì£½ì€ ë§ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p class="text-sm mt-1">ê°€ì¥ ìµœê·¼ì— ì£½ì€ ë§ì˜ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    `;
                }
            }

            function checkGameOver() {
                if (graveyardState.length >= 6) {
                    gameOverModal.classList.remove('hidden');
                    const winnersList = document.getElementById('winners-list');
                    winnersList.innerHTML = '';
                    
                    const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
                    const winnerPieces = gaugeState.slice(0, 3);
                    
                    winnerPieces.forEach((pieceId, i) => {
                        const pieceInfo = PIECES.find(p => p.id === pieceId);
                        const winnerCard = document.createElement('div');
                        winnerCard.className = `winner-card p-6 rounded-xl shadow-lg text-center ${pieceInfo.color}`;
                        winnerCard.innerHTML = `
                            <div class="text-4xl mb-2">${medals[i]}</div>
                            <div class="text-2xl font-bold">${i + 1}ë“±</div>
                            <div class="text-3xl font-bold mt-2">${formatId(pieceInfo.id)}</div>
                        `;
                        winnersList.appendChild(winnerCard);
                    });
                }
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            cardContainer.addEventListener('click', (e) => {
                if (e.target.matches('.card-button')) {
                    handleCardClick(e.target.dataset.card);
                }
            });
            
            closeModalBtn.addEventListener('click', closeCardModal);
            cardModal.addEventListener('click', (e) => {
                if(e.target === cardModal) closeCardModal();
            });
            restartBtn.addEventListener('click', initGame);

            // ì´ˆê¸° ê²Œì„ ì‹œì‘
            initGame();
        });
    </script>
</body>
</html>