<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <!-- 뷰포트 고정 (1280px): 모바일에서도 PC 화면 비율 유지 -->
    <meta name="viewport" content="width=1280">
    <title>카드 조합 페이지 (Version 2 - Mobile Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 화면 캡쳐 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibjNQVbXlmbrrdzaRhTygDabRESOLJtw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- [핵심] 모바일 터치를 드래그 이벤트로 변환해주는 라이브러리 (Polyfill) -->
    <script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>

    <style>
        body { 
            font-family: "Inter", sans-serif; 
            background-color: #f3f4f6; 
            color: #1f2937;
            margin: 0; padding: 0;
            min-width: 1280px; /* 레이아웃 깨짐 방지 */
            overflow-x: auto;
        }
        
        /* 스크롤바 커스텀 */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* 카드 공통 스타일 */
        .card-block {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            user-select: none; /* 텍스트 드래그 방지 */
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            padding: 0.25rem;
        }
        
        /* 드래그 대상 스타일 */
        .draggable-card { 
            cursor: grab; 
            width: 100%; height: 100%;
            /* [중요] 모바일에서 드래그 시 화면 스크롤 방지 */
            touch-action: none; 
        }
        .draggable-card:hover .card-block {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .draggable-card:active { cursor: grabbing; }
        .draggable-card:active .card-block { transform: scale(1.02); }

        /* 드롭 영역 스타일 */
        .dropzone {
            transition: all 0.2s ease-in-out;
            border: 2px dashed #d1d5db; 
            background-color: #f9fafb; 
            width: 100%;
            border-radius: 0.5rem;
            display: flex; align-items: center; justify-content: center;
            padding: 4px; 
            aspect-ratio: 5 / 7; 
            overflow: hidden; 
            position: relative;
        }
        
        /* 드롭존 색상 테마 */
        .dropzone-factor.blue-bg { background-color: #e0f2fe; /* sky-100 */ }
        .dropzone-factor.pink-bg { background-color: #fce7f3; /* pink-100 */ }
        
        .dropzone-relation { cursor: pointer; background-color: #ffffff; }
        .dropzone-relation:hover:not(.drop-filled) {
            transform: scale(1.02);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .drag-over {
            background-color: rgba(99, 102, 241, 0.1) !important;
            border-color: #6366f1 !important;
        }
        
        .drop-filled {
            border-style: solid; border-color: transparent;
            background-color: transparent !important; padding: 0; 
        }
        .drop-filled > .dropzone-placeholder { display: none; }
        
        #card-source-panel { border-right: 2px dashed #e5e7eb; }

        /* 모달 스타일 */
        .modal {
            position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.4); display: none;
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #ffffff; padding: 30px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 500px; width: 90%; position: relative;
        }
        .close-button {
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
            cursor: pointer; position: absolute; top: 15px; right: 20px;
        }
        /* 모달 내 카드 선택 스타일 */
        .modal-card-wrapper {
            cursor: pointer; transition: transform 0.2s;
            border: 2px solid transparent; border-radius: 0.5rem; padding: 4px;
        }
        .modal-card-wrapper:hover { transform: scale(1.05); }
        .modal-card-wrapper.selected { border-color: #6366f1; box-shadow: 0 0 0 3px #6366f1; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- 중앙 1280px 고정 컨테이너 -->
    <div id="layout-wrapper" class="w-[1280px] mx-auto bg-white min-h-screen shadow-2xl grid grid-cols-12 border-x border-gray-200">
        
        <!-- 좌측 패널 (3/12) -->
        <aside id="card-source-panel"
               class="col-span-3 bg-gray-50 p-4 sm:p-6" 
               data-zone-type="return"
               ondrop="drop(event)"
               ondragover="allowDrop(event)"
               ondragenter="dragEnter(event)"
               ondragleave="dragLeave(event)">
            
            <h2 class="text-2xl font-bold text-indigo-600 mb-6 text-center">기체의 상태(변화요인)</h2>
            <p class="text-center text-gray-500 text-sm mb-4 -mt-4">(카드를 여기로 드래그해서 되돌리기)</p>
            
            <!-- 카드 리스트 컨테이너 -->
            <div id="card-list-container" class="grid grid-cols-2 gap-3">
                <!-- 자바스크립트에서 초기화 시 여기에 카드가 생성됩니다 -->
            </div>
        </aside>

        <!-- 우측 작업 공간 (9/12) -->
        <main id="main-content" class="col-span-9 bg-white p-6 sm:p-8">
            
            <div class="bg-white rounded-xl p-6 sm:p-8 w-full flex flex-col space-y-6 border border-gray-100 shadow-sm">

                <!-- 모둠 입력 -->
                <div class="text-right font-bold text-xl text-gray-700">
                    기체의 성질 - (
                    <input type="text" class="w-16 text-center bg-white border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500 text-indigo-600 font-bold" placeholder="  ">
                    )모둠
                </div>

                <!-- 일정하게 유지해야하는 요인 -->
                <section>
                    <div class="flex justify-between items-center mb-4 max-w-2xl mx-auto">
                        <h3 class="text-xl font-semibold text-indigo-600 text-center pl-4">일정하게 유지해야하는 요인</h3>
                        <button id="add-const-slot-button" class="text-sm bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1 px-3 rounded-lg transition-colors shadow-sm">
                            (+) 추가하기
                        </button>
                    </div>
                    
                    <div id="constant-factors-grid" class="grid grid-cols-2 gap-4 max-w-md mx-auto">
                        <!-- 슬롯 1 (하늘색, 고정) -->
                        <div class="grid grid-cols-2 gap-2">
                            <div id="zone-const-factor-1" class="dropzone dropzone-factor blue-bg"
                                 data-zone-type="factor" data-zone-color="blue"
                                 ondrop="drop(event)" ondragover="allowDrop(event)"
                                 ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                                 <span class="dropzone-placeholder font-semibold text-blue-800 opacity-50">요인 카드</span>
                            </div>
                            <div id="zone-const-relation-1" class="dropzone dropzone-relation drop-filled cursor-default">
                                <!-- 고정된 일정 카드 (연보라색) -->
                                <div class="card-block bg-purple-200">
                                    <span class="text-3xl font-extrabold text-black">일정</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 슬롯 2 (분홍색, 팝업) -->
                        <div class="grid grid-cols-2 gap-2">
                            <div id="zone-const-factor-2" class="dropzone dropzone-factor pink-bg"
                                 data-zone-type="factor" data-zone-color="pink"
                                 ondrop="drop(event)" ondragover="allowDrop(event)"
                                 ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                                 <span class="dropzone-placeholder font-semibold text-pink-800 opacity-50">요인 카드</span>
                            </div>
                            <!-- 팝업으로 변경됨 -->
                            <div id="zone-const-relation-2" class="dropzone dropzone-relation"
                                 data-zone-type="relation"
                                 onclick="openRelationModal(this)">
                                 <span class="dropzone-placeholder text-gray-400">클릭</span>
                            </div>
                        </div>
                    </div>
                </section>

                <hr class="border-gray-200 my-2">

                <!-- 상호작용 -->
                <section class="flex-grow flex flex-col">
                    <h3 class="text-xl font-semibold text-indigo-600 mb-4 text-center">상호작용</h3>
                    
                    <div class="flex-grow grid grid-cols-3 items-center gap-4">
                        
                        <div class="flex flex-col space-y-4">
                            <div class="grid grid-cols-2 gap-2">
                                <div id="zone-inter-factor-1" class="dropzone dropzone-factor blue-bg"
                                     data-zone-type="factor" data-zone-color="blue"
                                     ondrop="drop(event)" ondragover="allowDrop(event)"
                                     ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                                     <span class="dropzone-placeholder font-semibold text-blue-800 opacity-50">요인 카드</span>
                                </div>
                                <div id="zone-inter-relation-1" class="dropzone dropzone-relation"
                                     data-zone-type="relation" onclick="openRelationModal(this)">
                                     <span class="dropzone-placeholder text-gray-400">클릭</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div id="zone-inter-factor-2" class="dropzone dropzone-factor pink-bg"
                                     data-zone-type="factor" data-zone-color="pink"
                                     ondrop="drop(event)" ondragover="allowDrop(event)"
                                     ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                                     <span class="dropzone-placeholder font-semibold text-pink-800 opacity-50">요인 카드</span>
                                </div>
                                <div id="zone-inter-relation-2" class="dropzone dropzone-relation"
                                     data-zone-type="relation" onclick="openRelationModal(this)">
                                     <span class="dropzone-placeholder text-gray-400">클릭</span>
                                </div>
                            </div>
                        </div>

                        <!-- 화살표 -->
                        <div class="flex flex-col items-center justify-center text-red-500 space-y-6">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-20 h-20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-20 h-20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M7 16l-4-4m0 0l4-4m-4 4h18" /></svg>
                        </div>
                        
                        <div class="flex flex-col space-y-4">
                            <div class="grid grid-cols-2 gap-2">
                                <div id="zone-inter-factor-3" class="dropzone dropzone-factor blue-bg"
                                     data-zone-type="factor" data-zone-color="blue"
                                     ondrop="drop(event)" ondragover="allowDrop(event)"
                                     ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                                     <span class="dropzone-placeholder font-semibold text-blue-800 opacity-50">요인 카드</span>
                                </div>
                                <div id="zone-inter-relation-3" class="dropzone dropzone-relation"
                                     data-zone-type="relation" onclick="openRelationModal(this)">
                                     <span class="dropzone-placeholder text-gray-400">클릭</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div id="zone-inter-factor-4" class="dropzone dropzone-factor pink-bg"
                                     data-zone-type="factor" data-zone-color="pink"
                                     ondrop="drop(event)" ondragover="allowDrop(event)"
                                     ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                                     <span class="dropzone-placeholder font-semibold text-pink-800 opacity-50">요인 카드</span>
                                </div>
                                <div id="zone-inter-relation-4" class="dropzone dropzone-relation"
                                     data-zone-type="relation" onclick="openRelationModal(this)">
                                     <span class="dropzone-placeholder text-gray-400">클릭</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <footer class="text-center mt-4">
                    <div class="flex justify-center space-x-4 mb-3">
                        <button id="reset-button" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold transition-colors">
                            초기화
                        </button>
                        <button id="capture-button" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors">
                            화면 캡쳐
                        </button>
                    </div>
                    <!-- 패들렛 이동 버튼 -->
                    <a href="https://padlet.com/gireumt01/padlet-m3quc3u08k7367gu" target="_blank" class="inline-block px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold transition-colors">
                        [패들렛으로 이동]
                    </a>
                </footer>
            </div>
        </main>
    </div>

    <!-- 팝업 모달 -->
    <div id="relationModal" class="modal">
        <div class="modal-content border-2 border-indigo-100">
            <span class="close-button">&times;</span>
            <h3 class="text-xl font-bold text-indigo-600 mb-6 text-center">변화 선택</h3>
            <div class="grid grid-cols-3 gap-4 justify-items-center max-w-sm mx-auto">
                
                <!-- 증가 (연녹색) -->
                <div class="modal-card-wrapper" data-card-id="card-up">
                    <div class="card-block bg-green-200 w-[100px] h-[140px]">
                        <span class="text-3xl font-extrabold text-black">증가</span>
                    </div>
                </div>
                
                <!-- 감소 (연노랑색) -->
                <div class="modal-card-wrapper" data-card-id="card-down">
                    <div class="card-block bg-yellow-200 w-[100px] h-[140px]">
                        <span class="text-3xl font-extrabold text-black">감소</span>
                    </div>
                </div>
                
                <!-- 일정 (연보라색) -->
                <div class="modal-card-wrapper" data-card-id="card-const">
                    <div class="card-block bg-purple-200 w-[100px] h-[140px]">
                        <span class="text-3xl font-extrabold text-black">일정</span>
                    </div>
                </div>
                
            </div>
            <div class="text-center mt-6">
                <button id="select-relation-button" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-md transition-colors">
                    선택 완료
                </button>
            </div>
        </div>
    </div>

    <script>
        // 카드 템플릿 생성 함수 (텍스트 블록)
        function createCardHTML(titleSmall, titleLarge, colorClass) {
            return `
                <div class="card-block ${colorClass}">
                    <span class="text-xs sm:text-sm font-bold text-gray-600 mb-1">${titleSmall}</span>
                    <span class="text-2xl sm:text-3xl font-extrabold text-black leading-tight text-center">${titleLarge}</span>
                </div>
            `;
        }

        // 관계 카드 템플릿 (모달 선택 시 사용)
        function createRelationCardHTML(text, colorClass) {
            return `
                <div class="card-block ${colorClass} w-full h-full">
                    <span class="text-3xl font-extrabold text-black">${text}</span>
                </div>
            `;
        }

        // 왼쪽 패널 카드 데이터 (텍스트)
        const factorCardsData = [
            { id: "card-vol", small: "기체의", large: "부피", color: "bg-sky-100", group: "blue" },
            { id: "card-dist", small: "입자 사이의", large: "거리", color: "bg-pink-100", group: "pink" },
            { id: "card-tem", small: "기체의", large: "온도", color: "bg-sky-100", group: "blue" },
            { id: "card-speed", small: "입자의", large: "속력", color: "bg-pink-100", group: "pink" },
            { id: "card-pre", small: "기체의", large: "압력", color: "bg-sky-100", group: "blue" },
            { id: "card-collide", small: "입자의", large: "충돌<br><span class='text-blue-900'>횟수</span>", color: "bg-pink-100", group: "pink" },
            { id: "card-strength", small: "입자의", large: "충돌<br><span class='text-blue-900'>세기</span>", color: "bg-pink-100", group: "pink" }
        ];

        // 관계 카드 데이터 (HTML 맵핑)
        const relationCardsHTML = {
            "card-up": createRelationCardHTML("증가", "bg-green-200"),
            "card-down": createRelationCardHTML("감소", "bg-yellow-200"),
            "card-const": createRelationCardHTML("일정", "bg-purple-200")
        };

        // 왼쪽 패널 초기화 함수
        function initLeftPanel() {
            const container = document.getElementById('card-list-container');
            container.innerHTML = '';
            
            factorCardsData.forEach(card => {
                // 래퍼 생성: max-w-[105px]로 우측 드롭존과 크기 일치시킴
                const wrapper = document.createElement('div');
                wrapper.className = "w-full max-w-[105px] aspect-[5/7] flex justify-center items-center bg-white rounded-lg shadow-sm border border-gray-100 p-1 mx-auto";
                
                // 드래그 가능한 카드 생성
                const dragDiv = document.createElement('div');
                dragDiv.id = card.id;
                dragDiv.className = "draggable-card";
                dragDiv.draggable = true;
                dragDiv.dataset.cardGroup = "factor";
                dragDiv.dataset.cardColor = card.group;
                dragDiv.ondragstart = drag;
                
                // 내부 디자인 HTML 삽입
                dragDiv.innerHTML = createCardHTML(card.small, card.large, card.color);
                
                wrapper.appendChild(dragDiv);
                container.appendChild(wrapper);
            });
        }

        // 페이지 로드 시 초기화
        initLeftPanel();

        let currentTargetDropzone = null;
        let selectedRelationCardId = null;
        let constantSlotCounter = 2;

        function allowDrop(ev) { ev.preventDefault(); }
        function drag(ev) {
            ev.dataTransfer.setData("text/plain", ev.target.id);
            ev.dataTransfer.setData("card-color", ev.target.dataset.cardColor);
        }
        function dragEnter(ev) {
            ev.preventDefault();
            const zoneType = ev.currentTarget.dataset.zoneType;
            if (zoneType === 'factor' || zoneType === 'return') ev.currentTarget.classList.add('drag-over');
        }
        function dragLeave(ev) { ev.currentTarget.classList.remove('drag-over'); }

        function drop(ev) {
            ev.preventDefault();
            const cardId = ev.dataTransfer.getData("text/plain");
            const cardColor = ev.dataTransfer.getData("card-color");
            const cardElement = document.getElementById(cardId);
            if (!cardElement) return;

            const dropZone = ev.currentTarget;
            const originalParent = cardElement.parentElement; 
            dropZone.classList.remove('drag-over');

            const zoneType = dropZone.dataset.zoneType;
            const zoneColor = dropZone.dataset.zoneColor;

            // 왼쪽 패널로 되돌리기
            if (zoneType === 'return') {
                returnCardToSource(cardElement);
                if (originalParent && originalParent.dataset.zoneType === 'factor') {
                    restorePlaceholder(originalParent, "요인 카드");
                }
                return;
            }

            // 오른쪽 슬롯에 드롭
            if (zoneType === 'factor') {
                if (cardColor !== zoneColor) {
                    console.warn("Color mismatch");
                    return; // 색상 불일치 시 거부
                }
                
                // 이미 카드가 있다면 되돌리기
                const existingCard = dropZone.querySelector('.draggable-card');
                if (existingCard) returnCardToSource(existingCard);
                
                dropZone.innerHTML = ''; // 플레이스홀더 제거
                dropZone.appendChild(cardElement); // DOM 이동
                dropZone.classList.add('drop-filled');
                
                // 원래 있던 곳이 팩터 드롭존이면 복원
                if (originalParent && originalParent.dataset.zoneType === 'factor' && originalParent.id !== dropZone.id) {
                     restorePlaceholder(originalParent, "요인 카드");
                }
            }
        }
        
        // 카드를 왼쪽 패널의 빈 래퍼로 되돌리기
        function returnCardToSource(cardElement) {
            if (!cardElement) return;
            
            const container = document.getElementById('card-list-container');
            const wrappers = container.querySelectorAll(':scope > div');
            let targetWrapper = null;
            
            // 비어있는 래퍼 찾기
            for (let wrapper of wrappers) {
                if (wrapper.childElementCount === 0) {
                    targetWrapper = wrapper;
                    break;
                }
            }
            
            // 비어있는 곳이 없으면 생성 (예외 처리)
            if (!targetWrapper) {
                targetWrapper = document.createElement('div');
                targetWrapper.className = "w-full max-w-[105px] aspect-[5/7] flex justify-center items-center bg-white rounded-lg shadow-sm border border-gray-100 p-1 mx-auto";
                container.appendChild(targetWrapper);
            }
            
            targetWrapper.appendChild(cardElement);
        }
        
        function restorePlaceholder(dropZone, text) {
            if (!dropZone) return;
            dropZone.innerHTML = `<span class="dropzone-placeholder font-semibold ${dropZone.dataset.zoneColor === 'blue' ? 'text-blue-800' : 'text-pink-800'} opacity-50">${text}</span>`;
            dropZone.classList.remove('drop-filled');
        }

        // 모달 관련 로직
        const relationModal = document.getElementById("relationModal");
        const closeButton = document.querySelector(".close-button");
        const selectRelationButton = document.getElementById("select-relation-button");
        const modalCards = document.querySelectorAll(".modal-card-wrapper");

        function openRelationModal(dropZone) {
            // 이미 카드가 있으면 클릭 시 제거 (토글)
            if (dropZone.classList.contains('drop-filled')) {
                restorePlaceholderRel(dropZone);
                return;
            }
            currentTargetDropzone = dropZone;
            relationModal.style.display = "flex";
            modalCards.forEach(card => card.classList.remove('selected'));
            selectedRelationCardId = null;
        }
        
        function restorePlaceholderRel(dropZone) {
             dropZone.innerHTML = `<span class="dropzone-placeholder text-gray-400">클릭</span>`;
             dropZone.classList.remove('drop-filled');
        }

        closeButton.onclick = function() { relationModal.style.display = "none"; }
        window.onclick = function(event) { if (event.target == relationModal) relationModal.style.display = "none"; }

        modalCards.forEach(card => {
            card.addEventListener('click', function() {
                modalCards.forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedRelationCardId = this.dataset.cardId;
            });
        });

        selectRelationButton.onclick = function() {
            if (selectedRelationCardId && currentTargetDropzone) {
                // HTML 블록 삽입
                currentTargetDropzone.innerHTML = relationCardsHTML[selectedRelationCardId];
                currentTargetDropzone.classList.add('drop-filled');
                relationModal.style.display = "none";
                currentTargetDropzone = null;
                selectedRelationCardId = null;
            } else {
                alert("카드를 선택해주세요!");
            }
        }

        // (+) 추가 버튼
        function addConstantFactorSlot() {
            constantSlotCounter++;
            const newSlotHTML = `
                <div class="grid grid-cols-2 gap-2 dynamic-slot">
                    <div id="zone-const-factor-${constantSlotCounter}" class="dropzone dropzone-factor pink-bg"
                         data-zone-type="factor" data-zone-color="pink">
                         <span class="dropzone-placeholder font-semibold text-pink-800 opacity-50">요인 카드</span>
                    </div>
                    <div id="zone-const-relation-${constantSlotCounter}" class="dropzone dropzone-relation"
                         data-zone-type="relation" onclick="openRelationModal(this)">
                         <span class="dropzone-placeholder text-gray-400">클릭</span>
                    </div>
                </div>
            `;
            const grid = document.getElementById('constant-factors-grid');
            grid.insertAdjacentHTML('beforeend', newSlotHTML);
            const newFactorZone = document.getElementById(`zone-const-factor-${constantSlotCounter}`);
            newFactorZone.ondrop = drop;
            newFactorZone.ondragover = allowDrop;
            newFactorZone.ondragenter = dragEnter;
            newFactorZone.ondragleave = dragLeave;
        }
        document.getElementById('add-const-slot-button').addEventListener('click', addConstantFactorSlot);

        // 초기화 버튼
        document.getElementById('reset-button').addEventListener('click', function() {
            // 1. 드롭존 리셋
            document.querySelectorAll('.dropzone-factor').forEach(zone => {
                restorePlaceholder(zone, "요인 카드");
            });
            document.querySelectorAll('[id^="zone-inter-relation"]').forEach(zone => {
                restorePlaceholderRel(zone);
            });
            const constRelationDropzone = document.getElementById('zone-const-relation-2');
            if (constRelationDropzone) restorePlaceholderRel(constRelationDropzone);

            // 2. 동적 슬롯 삭제
            document.querySelectorAll('.dynamic-slot').forEach(slot => slot.remove());
            constantSlotCounter = 2;
            
            // 3. 왼쪽 패널 재생성 (가장 깔끔한 초기화)
            initLeftPanel();
        });

        // 캡쳐 버튼
        document.getElementById('capture-button').addEventListener('click', function() {
            const captureElement = document.getElementById('main-content');
            const footerButtons = document.querySelector('footer');
            if (footerButtons) footerButtons.style.display = 'none';
            html2canvas(captureElement, {
                useCORS: true, backgroundColor: '#ffffff', scale: 2
            }).then(canvas => {
                const imageURL = canvas.toDataURL('image/png');
                const downloadLink = document.createElement('a');
                downloadLink.href = imageURL;
                downloadLink.download = 'card-combination.png';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                if (footerButtons) footerButtons.style.display = 'block';
            }).catch(err => {
                console.error("캡쳐 오류:", err);
                if (footerButtons) footerButtons.style.display = 'block';
                alert("캡쳐 실패.");
            });
        });
    </script>

</body>
</html>